rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------
    // USERS Collection
    // ----------------------------------------------------
    match /users/{userId} {
      allow read: if request.auth != null;

      allow create, delete: if request.auth != null
        && request.auth.uid == userId;

      // Allow update only for the 'preferences' field
      allow update: if request.auth != null
        && request.auth.uid == userId
        && request.writeFields.hasOnly([
      'displayName',
      'photoURL',
      'preferences.languagePreference',
      'preferences.themePreference',
      'preferences.gloveModePreference'
      ])
        && request.resource.data.preferences is map;

      // ---------------------------
      // Skis subcollection
      // ---------------------------
      match /skis/{skiId} {
        // Read if user owns the ski
        allow read: if request.auth != null
          && request.auth.uid == userId;

        // Create if user owns & plan-limits are satisfied
        allow create: if request.auth != null
          && request.auth.uid == userId
        // Plan & skiCount checks from your snippet:
          && (
        (get(/databases/$(database)/documents/users/$(userId)).data.plan == 'athlete'
          && get(/databases/$(database)/documents/users/$(userId)).data.skiCount < 48)
          ||
        (get(/databases/$(database)/documents/users/$(userId)).data.plan == 'coach'
          && get(/databases/$(database)/documents/users/$(userId)).data.skiCount < 200)
          ||
        (get(/databases/$(database)/documents/users/$(userId)).data.plan == 'company'
          && get(/databases/$(database)/documents/users/$(userId)).data.skiCount < 5000)
          ||
        (get(/databases/$(database)/documents/users/$(userId)).data.plan == 'free'
          && get(/databases/$(database)/documents/users/$(userId)).data.skiCount < 12)
        )
        // Do not try to set 'locked' manually
          && !('locked' in request.resource.data);

        // Update if user owns the ski & does not modify 'locked'
        allow update: if request.auth != null
          && request.auth.uid == userId
          && (request.resource.data.diff(resource.data).affectedKeys().hasOnly([
        'serialNumber',
        'style',
        'brand',
        'model',
        'length',
        'stiffness',
        'base',
        'construction',
        'grind',
        'grindDate',
        'comment',
        'grindHistory',
        'dateAdded',
        'newGrind',
        'newGrindDate',
        'testIds',
        'archived',
        'skiType',
        'keywords_en',
        'keywords_no',
        'archived'
        ]));

        // Delete if user owns the ski
        allow delete: if request.auth != null
          && request.auth.uid == userId;
      }

      // ---------------------------
      // User-level testResults subcollection
      // ---------------------------
      match /testResults/{testId} {
        allow read, write, delete: if request.auth != null
          && request.auth.uid == userId;
      }
    }

    // ----------------------------------------------------
    // CONTACT Collection
    // ----------------------------------------------------
    match /contact/{contactId} {
      allow read, write: if request.auth != null;
    }


    // ----------------------------------------------------
    // TEAMS Collection
    // ----------------------------------------------------
    match /teams/{teamId} {

      // Helper for checking if user is coach or company
      function isCoachOrCompany() {
        return request.auth != null
          && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.plan in ['coach','company']);
      }

      // Because we are reading *this same doc*, we use resource.data to check membership:
      allow create: if isCoachOrCompany();

      // READ this team doc if user is in team’s members array
      allow read: if request.auth != null
        && (request.auth.uid in resource.data.members);

      // UPDATE/DELETE
      allow update, delete: if request.auth != null 
        && request.auth.uid == resource.data.createdBy;

      // ------------------------------------------------
      // Events subcollection
      // ------------------------------------------------
      match /events/{eventId} {
      // We can use a function that does *get* on /teams/{teamId},
        // because it’s a different doc than /teams/{teamId}/events/{eventId}.
        // This avoids recursion issues:
        function isTeamMember() {
          return request.auth != null
            && (request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.members);
        }

        allow create: if isTeamMember() && isCoachOrCompany();

        allow read: if isTeamMember();

        allow update, delete: if isTeamMember() && isCoachOrCompany();

        // testResults within an event
        match /testResults/{testId} {
          allow read, create, update, delete: if isTeamMember();
        }
      }
    }
  }
}