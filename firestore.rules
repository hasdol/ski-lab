rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // Allow users to read, create, and delete their own user document
      allow read, create, delete: if request.auth != null && request.auth.uid == userId;

      // Allow update only for the 'preferences' field
      allow update: if request.auth != null
        && request.auth.uid == userId
        && request.writeFields.hasOnly([
      'preferences.languagePreference',
      'preferences.themePreference',
      'preferences.gloveModePreference'
      ])
        && request.resource.data.preferences is map;

      // Match skis subcollection
      match /skis/{skiId} {
        // Allow users to read all their skis
        allow read: if request.auth != null 
          && request.auth.uid == userId;


        // Allow create if user owns the ski and hasn't exceeded ski limit
        allow create: if request.auth != null
          && request.auth.uid == userId
          && (
        (get(/databases/$(database)/documents/users/$(userId)).data.isPro == true 
          && get(/databases/$(database)/documents/users/$(userId)).data.skiCount < 48)
          ||
        (get(/databases/$(database)/documents/users/$(userId)).data.isPro == false 
          && get(/databases/$(database)/documents/users/$(userId)).data.skiCount < 12)
        );

        // Allow update if user owns the ski and does not modify 'locked' field
        allow update: if request.auth != null 
          && request.auth.uid == userId
          && (request.resource.data.diff(resource.data).affectedKeys().hasOnly([
        'serialNumber',
        'style',
        'brand',
        'model',
        'length',
        'stiffness',
        'base',
        'construction',
        'grind',
        'grindDate',
        'comment',
        'grindHistory',
        'dateAdded',
        'newGrind',
        'newGrindDate',
        'testIds',
        'archived',
        'skiType'
        ]))     

        // Allow delete if user owns the ski
        allow delete: if request.auth != null 
          && request.auth.uid == userId;
      }

      // Secure 'testResults' subcollection
      match /testResults/{testId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
    }
    // Secure 'contact' collection
    match /contact/{contactId} {
      allow read, write: if request.auth != null;
    }
  }
}
